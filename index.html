<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEA Quick Survey by PEA NAKHONPHANOM</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Styles --- */
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        body.noscroll { overflow: hidden; }

        nav { background-color: #1a237e; width: 100%; padding: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; justify-content: center; flex-wrap: wrap; }
        nav button { background-color: transparent; color: #c5cae9; border: none; padding: 15px 20px; font-size: 16px; font-weight: 600; cursor: pointer; border-bottom: 4px solid transparent; transition: all 0.3s; flex-grow: 1; max-width: 200px; }
        nav button:hover { color: white; background-color: rgba(255,255,255,0.1); }
        nav button.active { color: white; border-bottom: 4px solid #ffca28; }
        
        .container { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); width: 90%; max-width: 500px; margin-top: 30px; margin-bottom: 30px; }
        h2 { text-align: center; color: #333; margin-top: 0; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        
        .input-group { margin-bottom: 15px; } .input-row { display: flex; gap: 15px; margin-bottom: 15px; } .input-half { flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; background-color: #fff; }
        
        .quick-btn-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .quick-btn { flex: 1; min-width: 50px; padding: 8px; background-color: #e3f2fd; border: 1px solid #90caf9; color: #1565c0; border-radius: 20px; cursor: pointer; font-size: 14px; transition: 0.2s; text-align: center; }
        
        button.calculate-btn { width: 100%; padding: 12px; background-color: #1a237e; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: background 0.3s; }
        button.calculate-btn:hover { background-color: #0d47a1; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; }
        
        .external-link-btn { display: block; width: 100%; text-align: center; padding: 10px; background-color: #ff9800; color: white; text-decoration: none; border-radius: 6px; margin-top: 15px; font-weight: bold; transition: background 0.3s; box-sizing: border-box;}
        
        .result { margin-top: 25px; padding: 20px; background-color: #f8f9fa; border-left: 5px solid #1a237e; border-radius: 4px; display: none; }
        .result p { margin: 8px 0; color: #333; font-size: 16px; }
        .note { font-size: 13px; color: #555; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc; line-height: 1.6; }
        .small-text { font-size: 13px; color: #555; font-weight: normal; }
        .credit-box { margin-top: 12px; padding: 10px; border-top: 1px dashed #ccc; color: #1a237e; font-weight: 600; text-align: center; background-color: #e8eaf6; border-radius: 5px; }
        
        .gps-status { text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 15px; border: 1px solid #90caf9; transition: background 0.3s;}
        .gps-status.waiting { background: #fff3e0; border-color: #ffb74d; }
        .gps-val { font-size: 24px; font-weight: bold; color: #1565c0; display: block; margin: 5px 0;}
        .gps-label { font-size: 14px; color: #555; }
        
        .manual-pin-btn { background-color: #f57f17 !important; margin-top: 10px; font-size: 18px !important; padding: 20px !important; box-shadow: 0 4px 6px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        
        .history-container { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 5px; margin-bottom: 10px; }
        .history-item { background: #fff; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 6px; display: flex; flex-direction:column; gap:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;}
        .history-info { font-size: 15px; color: #333; font-weight:bold;}
        .history-meta { font-size: 12px; color: #777; }
        .history-actions { display:flex; gap:5px; width:100%;}
        .history-actions button { flex:1; padding: 8px; font-size: 12px; border-radius: 4px; cursor: pointer; border: none; color: white; display:flex; justify-content:center; align-items:center;}
        .upload-status { font-size: 12px; color: #2e7d32; font-weight: bold; position: absolute; top: 10px; right: 10px; display: none;}
        
        .status-btn { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; cursor: pointer; border: none; margin-left: 5px; display: inline-block; }
        .status-pending { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .status-done { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        
        .photo-preview { width: 100%; max-height: 200px; object-fit: contain; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; display: none; }
        .photo-btn { background-color: #607d8b; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .table-thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; cursor:pointer;}
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 350px; text-align: center; position: relative;}
        .modal input { margin: 15px 0; text-align: center; letter-spacing: 5px; font-weight: bold; }
        
        .summary-section { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 10px; }
        .filter-controls { display: flex; gap: 5px; margin-bottom: 10px; }
        .filter-controls select { padding: 5px; font-size: 13px; }
        .toggle-table-btn { background: none; border: none; color: #1a237e; font-weight: bold; cursor: pointer; text-decoration: underline; font-size: 14px; margin-bottom: 10px;}
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; } 
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle;}
        .data-table th { background-color: #f2f2f2; color: #333; }
        
        .fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .fullscreen-overlay .data-table { font-size: 14px; width: 100%; }
        .fullscreen-overlay .filter-controls { justify-content: center; }
        
        .table-responsive { overflow-x: auto; width: 100%; }
        .fullscreen-btn { cursor: pointer; background: #e3f2fd; border: 1px solid #90caf9; color: #1565c0; padding: 4px 10px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
        .close-fs-btn { align-self: flex-end; margin-bottom: 10px; background: #d32f2f; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Resume Alert Box - ‡πÄ‡∏û‡∏¥‡πà‡∏° Animation ‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô */
        .resume-alert { 
            background-color: #fff8e1; 
            border: 2px solid #ffb300; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            display: none; /* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
            animation: slideDown 0.5s ease-out; 
            text-align: center; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .resume-btn { background-color: #ff6f00 !important; margin-top: 10px; width: 100%; font-size: 18px !important; padding: 15px !important;}
        .pause-btn { background-color: #607d8b !important; margin-top: 10px; width: 100%; border: 1px dashed #ccc !important;}

        footer { margin-top: auto; margin-bottom: 20px; color: #777; font-size: 14px; text-align: center; font-weight: 600; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <nav>
        <button onclick="openTab('ampToUnit')" id="btn-ampToUnit" style="display:none;">1. ‡πÅ‡∏õ‡∏•‡∏á Amp</button>
        <button onclick="openTab('solarRoof')" id="btn-solarRoof" style="display:none;">2. Solar Roof</button>
        <button onclick="openTab('voltageDrop')" id="btn-voltageDrop" style="display:none;">3. V-Drop</button>
        <button onclick="openTab('gpsSurvey')" id="btn-gpsSurvey" class="active" style="max-width: none;">PEA Quick Survey</button>
    </nav>

    <div class="container">
        <div id="ampToUnit" class="tab-content">
             <h2>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (Amp)</h2>
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏î‡πà‡∏ß‡∏ô:</label>
            <div class="quick-btn-group">
                <button class="quick-btn" onclick="setAmp(1)">1A</button>
                <button class="quick-btn" onclick="setAmp(5)">5A</button>
                <button class="quick-btn" onclick="setAmp(15)">15A</button>
                <button class="quick-btn" onclick="setAmp(30)">30A</button>
            </div>
            <div class="input-row">
                <div class="input-half"><label>P.F.:</label><input type="number" id="inputPF" value="0.85" step="0.01" oninput="reCalcAll()"></div>
                <div class="input-half"><label>L.F.:</label><input type="number" id="inputLF" value="0.5" step="0.1" oninput="reCalcAll()"></div>
            </div>
            <div class="input-group">
                <label>‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á:</label>
                <select id="trafoSelect" onchange="selectTrafo()">
                    <option value="0">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á) --</option>
                    <optgroup label="1 ‡πÄ‡∏ü‡∏™">
                        <option value="30_1">30 kVA (1 Phase)</option>
                    </optgroup>
                    <optgroup label="3 ‡πÄ‡∏ü‡∏™">
                        <option value="50_3">50 kVA</option>
                        <option value="100_3">100 kVA</option>
                        <option value="160_3">160 kVA</option>
                        <option value="250_3">250 kVA</option>
                        <option value="315_3">315 kVA</option>
                        <option value="400_3">400 kVA</option>
                        <option value="500_3">500 kVA</option>
                        <option value="630_3">630 kVA</option>
                        <option value="800_3">800 kVA</option>
                        <option value="1000_3">1000 kVA</option>
                    </optgroup>
                </select>
            </div>
            <div class="input-group"><label>‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (Amps/Phase):</label><input type="number" id="ampInput" value="1" oninput="calculateAmp()"></div>
            <button class="calculate-btn" onclick="calculateAmp()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
            <div id="result-amp" class="result">
                <p>‚ö° ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏ü:</p>
                <p>‚Ä¢ <strong><span id="ampResultPhase">0</span> ‡∏´‡∏ô‡πà‡∏ß‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡πÄ‡∏ü‡∏™</strong></p>
                <div id="threePhaseSummary" style="display:none; margin-top:10px; padding-top:10px; border-top:1px solid #ddd;">
                    <p>‚ö° ‡∏£‡∏ß‡∏° 3 ‡πÄ‡∏ü‡∏™ (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì):</p><p style="color:#1a237e;"><strong><span id="ampResultTotal">0</span> ‡∏´‡∏ô‡πà‡∏ß‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</strong></p>
                </div>
                <div class="note">*‡∏™‡∏π‡∏ï‡∏£ Manual: 1A ‚âà 70 ‡∏´‡∏ô‡πà‡∏ß‡∏¢<br>*‡∏™‡∏π‡∏ï‡∏£‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á: <strong>10 kVA ‚âà 3,000 ‡∏´‡∏ô‡πà‡∏ß‡∏¢</strong></div>
            </div>
        </div>
        <div id="solarRoof" class="tab-content">
             <h2>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Solar Rooftop</h2>
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏î‡πà‡∏ß‡∏ô (kW):</label>
            <div class="quick-btn-group">
                <button class="quick-btn" onclick="setSolar(1)">1kW</button>
                <button class="quick-btn" onclick="setSolar(3)">3kW</button>
                <button class="quick-btn" onclick="setSolar(5)">5kW</button>
                <button class="quick-btn" onclick="setSolar(10)">10kW</button>
                <button class="quick-btn" onclick="setSolar(20)">20kW</button>
            </div>
            <div class="input-group"><label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á (kW):</label><input type="number" id="solarSize" value="1" oninput="calculateSolar()"></div>
            <button class="calculate-btn" onclick="calculateSolar()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
            <div id="result-solar" class="result">
                <p>‚ö° ‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏ü‡πÑ‡∏î‡πâ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô): <strong id="solarMonth">120</strong> ‡∏´‡∏ô‡πà‡∏ß‡∏¢</p>
                <p>üí∞ ‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞: <strong id="solarMoney">500</strong> ‡∏ö‡∏≤‡∏ó</p>
                <a href="https://peasolar.pea.co.th/our-products/" target="_blank" class="external-link-btn">‡∏î‡∏π‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå PEA Solar ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a>
            </div>
        </div>
        <div id="voltageDrop" class="tab-content">
             <h2>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Voltage Drop</h2>
            <div class="input-group"><label>‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á (Source Voltage):</label><input type="number" id="vd_source" value="230" placeholder="‡πÄ‡∏ä‡πà‡∏ô 230 ‡∏´‡∏£‡∏∑‡∏≠ 400" oninput="calculateVDrop()"></div>
            <div class="input-group"><label>‡∏ä‡∏ô‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏ô‡∏≥:</label>
                <select id="conductorType" onchange="calculateVDrop()">
                    <option value="Cu">‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á (Copper)</option>
                    <option value="Al">‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (Aluminum)</option>
                </select>
            </div>
            <div class="input-group"><label>‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (Amps):</label><input type="number" id="vd_current" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15" oninput="calculateVDrop()"></div>
            <div class="input-group"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏™‡∏≤‡∏¢ (‡πÄ‡∏°‡∏ï‡∏£):</label><input type="number" id="vd_distance" placeholder="‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏™‡∏≤‡∏¢" oninput="calculateVDrop()"></div>
            <div class="input-group"><label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏≤‡∏¢‡πÑ‡∏ü (sq.mm):</label>
                <select id="vd_cableSize" onchange="calculateVDrop()">
                    <option value="1">1 sq.mm</option><option value="1.5">1.5 sq.mm</option><option value="2.5" selected>2.5 sq.mm</option><option value="4">4 sq.mm</option><option value="6">6 sq.mm</option><option value="10">10 sq.mm</option><option value="16">16 sq.mm</option><option value="25">25 sq.mm</option><option value="35">35 sq.mm</option><option value="50">50 sq.mm</option><option value="70">70 sq.mm</option><option value="95">95 sq.mm</option><option value="120">120 sq.mm</option><option value="150">150 sq.mm</option><option value="185">185 sq.mm</option><option value="240">240 sq.mm</option>
                </select>
            </div>
            <button class="calculate-btn" onclick="calculateVDrop()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì V-Drop</button>
            <div id="result-vdrop" class="result">
                <p>üìâ ‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ï‡∏Å (V): <strong id="vDropVal">0</strong> V</p>
                <p>üìä ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå: <strong id="vDropPercent">0</strong> %</p>
                <p>üîå ‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á: <strong id="vEnd">0</strong> V</p>
            </div>
        </div>

        <div id="gpsSurvey" class="tab-content active">
            <h2>‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏ß‡∏à ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏Ç‡∏ï</h2>

            <div id="resumeAlert" class="resume-alert">
                <div style="font-weight:bold; color:#e65100; font-size:18px;">‚ö† ‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</div>
                <div id="resumeInfo" style="font-size:14px; color:#555; margin:10px 0;"></div>
                <button class="calculate-btn resume-btn" onclick="resumeSurvey()">‚ñ∂ ‡∏™‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏° (Resume)</button>
                <div style="margin-top:10px; font-size:13px; text-decoration:underline; cursor:pointer; color:#d32f2f;" onclick="clearDraft()">‚ùå ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)</div>
            </div>
            
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #90caf9;">
                <h3 style="margin-top:0; font-size:16px; border-bottom:none; text-align:left;">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡∏Å‡∏£‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°)</h3>
                <div class="input-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á: <span style="color:red">*</span></label>
                    <input type="text" id="trackName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô 140 ‡πÄ‡∏°‡∏ï‡∏£..." oninput="saveToDraft()">
                </div>
                <div class="input-group">
                    <label>‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à: <span style="color:red">*</span></label>
                    <input list="surveyorList" id="surveyorName" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠..." oninput="saveToDraft()">
                    <datalist id="surveyorList"></datalist>
                </div>
                <label style="margin-bottom:10px;">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠(‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô): <span style="color:red">*</span></label>
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handleImageSelect(this)">
                <button class="photo-btn" onclick="document.getElementById('cameraInput').click()">
                    üì∑ ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                </button>
                <img id="previewImg" class="photo-preview">
                <div id="imgStatus" style="font-size:12px; color:#c62828; display:none; font-weight:bold;">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</div>
            </div>

            <div id="gpsBox" class="gps-status" style="opacity: 0.6; pointer-events: none;">
                <span id="gpsStatusText">‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</span>
                <hr style="border:0; border-top:1px solid #90caf9; margin:10px 0;">
                <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                    <div style="flex:1;">
                        <span class="gps-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏°‡∏∏‡∏î</span>
                        <span class="gps-val" id="displayPoints">0</span>
                    </div>
                    <div style="flex:1; border-left:1px solid #ccc;">
                        <span class="gps-label">‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏ß‡∏° (‡∏°.)</span>
                        <span class="gps-val" id="displayDistance">0</span>
                    </div>
                </div>
                <div style="background: white; padding: 8px; border-radius: 5px; margin-bottom: 5px;">
                    <span class="gps-label">‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
                    <strong id="displayDistFromLast" style="color: #e65100; font-size: 18px;">0</strong> <span class="small-text">‡∏°.</span>
                </div>
                <div style="margin-top:5px; font-size:12px; color:#555;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: <span id="displayAccuracy" style="font-weight:bold;">-</span></div>
            </div>
            
            <div id="controlPanel">
                <button class="calculate-btn" id="btnStartGPS" onclick="startSurvey()" style="background-color: #2e7d32; margin-top:15px;">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏ß‡∏à</button>
                <button class="calculate-btn manual-pin-btn" id="btnDropPin" onclick="dropPin()" style="display:none;">üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ (Pin)</button>
                
                <div id="savePanel" style="display:none; margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
                    <button class="calculate-btn" id="btnFinalSave" onclick="saveTrack()" style="background-color: #1976d2;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button class="calculate-btn pause-btn" onclick="pauseSurvey()">‚è∏ ‡∏û‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Draft)</button>
                    <button class="calculate-btn" onclick="resetSurvey(false)" style="background-color: #d32f2f; margin-top:10px;">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                </div>
            </div>

            <div id="savedListContainer" style="display:none; margin-top:20px;">
                <h3 style="margin-top:0; color:#555; font-size:16px;">üìÇ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</h3>
                <div class="history-container">
                    <div id="savedRoutesList"></div>
                </div>
                <div class="note" style="text-align:center; color:#d32f2f; cursor:pointer;" onclick="initDelete('all', null)">[‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î]</div>
            </div>

            <div class="summary-section" id="personalWrapper" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                     <button class="toggle-table-btn" onclick="toggleSummaryTable()" style="margin:0;">üìä ‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (Click)</button>
                     <button class="fullscreen-btn" onclick="toggleFullscreen('personalWrapper')">‚õ∂ ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</button>
                </div>
                
                <button class="close-fs-btn" style="display:none;" onclick="toggleFullscreen('personalWrapper')">‚ùå ‡∏¢‡πà‡∏≠</button>

                <div class="filter-controls">
                    <select id="filterSurveyor" onchange="applyFilters()"><option value="all">‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
                    <select id="filterStatus" onchange="applyFilters()">
                        <option value="all">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="pending">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á</option>
                        <option value="done">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß</option>
                    </select>
                </div>
                <div class="table-responsive">
                    <table class="data-table" id="summaryTable">
                        <thead><tr><th>#</th><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</th><th>‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à</th><th>‡∏£‡∏∞‡∏¢‡∏∞(‡∏°.)</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                        <tbody id="summaryTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div style="margin-top:20px; border-top:2px solid #1a237e; padding-top:15px;">
                <button class="calculate-btn" onclick="initViewTeamData()" style="background-color: #455a64;">üåê ‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á(Team)</button>
                
                <div id="publicWrapper" style="display:none; margin-top:10px;">
                    
                    <div style="display:flex; justify-content:flex-end; margin-bottom:5px;">
                        <button class="fullscreen-btn" onclick="toggleFullscreen('publicWrapper')">‚õ∂ ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</button>
                    </div>
                    
                    <button class="close-fs-btn" style="display:none;" onclick="toggleFullscreen('publicWrapper')">‚ùå ‡∏¢‡πà‡∏≠</button>

                    <div class="filter-controls" style="background:#e8f5e9; padding:10px; border-radius:6px; margin-bottom:10px;">
                        <span style="font-size:12px; font-weight:bold; align-self:center;">‡∏Å‡∏£‡∏≠‡∏á: </span>
                        <select id="publicFilterSurveyor" onchange="applyPublicFilters()"><option value="all">‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
                        <select id="publicFilterStatus" onchange="applyPublicFilters()">
                            <option value="all">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="pending">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á</option>
                            <option value="done">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                         <table class="data-table">
                            <thead><tr><th>#</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</th><th>‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à</th><th>‡∏£‡∏∞‡∏¢‡∏∞(‡∏°.)</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</th><th>Download</th></tr></thead>
                            <tbody id="publicTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="note">* ‡∏Å‡∏î "‚òÅ ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏°‡πÄ‡∏´‡πá‡∏ô</div>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
            <p id="passwordPromptText">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</p>
            <input type="password" id="adminPassword" placeholder="PIN" inputmode="numeric">
            <div style="display:flex; gap:10px;">
                <button class="calculate-btn" style="background:#ccc; color:#333;" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="calculate-btn" id="btnConfirmPassword">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>
    <div id="imageModal" class="modal" onclick="closeImageModal()">
        <div class="modal-content" style="max-width: 90%; background:transparent; box-shadow:none;">
            <img id="fullImage" style="width:100%; border-radius:8px; border:2px solid white;">
            <button class="calculate-btn" onclick="closeImageModal()" style="margin-top:10px; background:white; color:black;">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <footer>Developed by PEA Nakhon Phanom - Customer Service and Relations Section (‡∏ä‡∏ú.‡∏ö‡∏™.‡∏Å‡∏ü‡∏à.‡∏ô‡∏û.)</footer>

    <script>
        // *** ‡πÉ‡∏™‡πà URL Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
        var SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw9LqjHRaZcJ8PXUQAwX5E9jo391wUDiQhEexn-JBk2VdSPoetYWKihID8t2tg1uaJV/exec"; 

        // --- Auth State ---
        var isTeamDataUnlocked = false; 
        var currentPassAction = null;   
        var deleteTargetId = null;
        var deleteMode = null;

        // --- Core Functions ---
        function openTab(tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) { tabcontent[i].className = tabcontent[i].className.replace(" active", ""); }
            tablinks = document.getElementsByTagName("button");
            for (i = 0; i < tablinks.length; i++) { tablinks[i].classList.remove("active"); }
            var targetTab = document.getElementById(tabName);
            if(targetTab) targetTab.className += " active";
            var btn = document.getElementById("btn-" + tabName);
            if(btn) btn.classList.add("active");
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Draft ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ GPS
            if(tabName === 'gpsSurvey') checkForDraft();
        }
        function reCalcAll() { if (document.getElementById('trafoSelect').value !== "0") selectTrafo(); else calculateAmp(); }
        function setAmp(val) { document.getElementById('ampInput').value = val; document.getElementById('trafoSelect').value = "0"; calculateAmp(); }
        function selectTrafo() {
            var val = document.getElementById('trafoSelect').value; if (val === "0") return;
            var pf = parseFloat(document.getElementById('inputPF').value)||0.85; var lf = parseFloat(document.getElementById('inputLF').value)||0.5;
            var kva=0; var amps=0; var is3=false;
            if (val === "30_1") { kva=30; amps=130; is3=false; }
            else { kva=parseInt(val.split('_')[0]); amps=Math.round((kva*1000)/(1.732*400)); is3=true; }
            var totalUnits = kva * 300 * (pf/0.85) * (lf/0.5);
            document.getElementById('ampInput').value = amps; displayUnits(totalUnits, is3);
        }
        function calculateAmp() {
            var amp = parseFloat(document.getElementById('ampInput').value);
            if (isNaN(amp)) { document.getElementById('ampResultPhase').innerText="0"; return; }
            if (document.getElementById('trafoSelect').value === "0") {
                var pf = parseFloat(document.getElementById('inputPF').value)||0.85; var lf = parseFloat(document.getElementById('inputLF').value)||0.5;
                var units = (amp*70)*(pf/0.85)*(lf/0.5);
                document.getElementById('ampResultPhase').innerText = Math.round(units).toLocaleString();
                document.getElementById('threePhaseSummary').style.display = "none";
                document.getElementById('result-amp').style.display = 'block';
            }
        }
        function displayUnits(total, is3) {
            var rounded = (total>10000) ? Math.round(total/1000)*1000 : Math.round(total/100)*100;
            if (is3) {
                var perPhase = rounded/3; perPhase = (perPhase>1000) ? Math.round(perPhase/100)*100 : Math.round(perPhase/10)*10;
                document.getElementById('ampResultPhase').innerText = perPhase.toLocaleString();
                document.getElementById('ampResultTotal').innerText = rounded.toLocaleString();
                document.getElementById('threePhaseSummary').style.display = "block";
            } else {
                document.getElementById('ampResultPhase').innerText = rounded.toLocaleString();
                document.getElementById('threePhaseSummary').style.display = "none";
            }
            document.getElementById('result-amp').style.display = 'block';
        }
        function setSolar(val) { document.getElementById('solarSize').value=val; calculateSolar(); }
        function calculateSolar() {
            var size = parseFloat(document.getElementById('solarSize').value);
            if (isNaN(size)||size<0) return;
            document.getElementById('solarDay').innerText = (size*4).toLocaleString(undefined,{maximumFractionDigits:1});
            document.getElementById('solarMonth').innerText = (size*120).toLocaleString(undefined,{maximumFractionDigits:0});
            document.getElementById('solarMoney').innerText = (size*500).toLocaleString();
            document.getElementById('result-solar').style.display = 'block';
        }
        function calculateVDrop() {
            var I = parseFloat(document.getElementById('vd_current').value);
            var L = parseFloat(document.getElementById('vd_distance').value);
            var A = parseFloat(document.getElementById('vd_cableSize').value);
            var type = document.getElementById('conductorType').value;
            var V_source = parseFloat(document.getElementById('vd_source').value);
            if (isNaN(V_source)) V_source = 230; 
            var rho = 0.0178; var matName = "‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á (Copper)";
            if (type === 'Al') { rho = 0.028; matName = "‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏° (Aluminum)"; }
            if (isNaN(I) || isNaN(L)) return;
            var vDrop = (2 * L * I * rho) / A;
            var percent = (vDrop / V_source) * 100;
            var vEnd = V_source - vDrop;
            document.getElementById('vDropVal').innerText = vDrop.toFixed(2);
            document.getElementById('vDropPercent').innerText = percent.toFixed(2);
            document.getElementById('vEnd').innerText = vEnd.toFixed(2);
            document.getElementById('vDropPercent').style.color = (percent > 5) ? "red" : "#2e7d32";
            document.getElementById('result-vdrop').style.display = 'block';
        }

        // --- GPS & Save ---
        var watchID = null;
        var currentLat = null, currentLon = null, currentAcc = null;
        var recordedPoints = [];
        var fixedDistance = 0; 
        var currentImageData = null;
        var globalPublicData = []; 

        function startSurvey() {
            var name = document.getElementById('trackName').value;
            var surveyor = document.getElementById('surveyorName').value;
            if(!name || !surveyor || !currentImageData) {
                alert("‚ö† ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á', '‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à' ‡πÅ‡∏•‡∏∞ '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ' ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à");
                return;
            }
            if (!navigator.geolocation) { alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS"); return; }
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£
            document.getElementById('gpsBox').style.opacity = "1";
            document.getElementById('gpsBox').style.pointerEvents = "auto";
            recordedPoints = []; fixedDistance = 0; 
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Draft ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°
            saveToDraft();

            document.getElementById('displayPoints').innerText = "0";
            document.getElementById('displayDistance').innerText = "0";
            document.getElementById('displayDistFromLast').innerText = "0";
            document.getElementById('btnStartGPS').style.display = 'none';
            document.getElementById('btnDropPin').style.display = 'block';
            document.getElementById('savePanel').style.display = 'block';
            document.getElementById('gpsStatusText').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì...";

            startGPSWatcher();
        }

        function startGPSWatcher() {
            if(watchID) navigator.geolocation.clearWatch(watchID);
            watchID = navigator.geolocation.watchPosition(
                function(pos) {
                    currentLat = pos.coords.latitude; currentLon = pos.coords.longitude; currentAcc = pos.coords.accuracy;
                    document.getElementById('displayAccuracy').innerText = "¬±" + Math.round(currentAcc) + " ‡∏°.";
                    var distFromLast = 0;
                    if (recordedPoints.length > 0) {
                        var lastPt = recordedPoints[recordedPoints.length - 1];
                        distFromLast = calcDist(lastPt[1], lastPt[0], currentLat, currentLon);
                    }
                    document.getElementById('displayDistFromLast').innerText = distFromLast.toFixed(0);
                    document.getElementById('displayDistance').innerText = (fixedDistance + distFromLast).toFixed(0);
                    var gpsBox = document.getElementById('gpsBox');
                    var statusText = document.getElementById('gpsStatusText');
                    if(currentAcc > 20) { gpsBox.className = "gps-status waiting"; statusText.innerText = "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡πà‡∏≠‡∏ô..."; statusText.style.color = "#e65100"; } 
                    else { gpsBox.className = "gps-status"; statusText.innerText = "GPS ‡∏û‡∏£‡πâ‡∏≠‡∏°!"; statusText.style.color = "#2e7d32"; }
                },
                function(err) { console.warn(err); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function dropPin() {
            if (currentLat === null) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS"); return; }
            var newPoint = [currentLon, currentLat];
            if (recordedPoints.length > 0) {
                var lastPt = recordedPoints[recordedPoints.length - 1];
                var dist = calcDist(lastPt[1], lastPt[0], currentLat, currentLon);
                fixedDistance += dist;
            }
            recordedPoints.push(newPoint);
            
            // Auto Save Draft ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
            saveToDraft();

            document.getElementById('displayPoints').innerText = recordedPoints.length;
            document.getElementById('displayDistance').innerText = fixedDistance.toFixed(0);
            document.getElementById('displayDistFromLast').innerText = "0";
            var btn = document.getElementById('btnDropPin');
            var originalText = btn.innerText;
            btn.innerText = "‚úÖ ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß!"; btn.style.backgroundColor = "#43a047";
            setTimeout(() => { btn.innerText = originalText; btn.style.backgroundColor = "#f57f17"; }, 1000);
        }

        // --- DRAFT SYSTEM (‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á) ---
        function saveToDraft() {
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ ‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à
            var draft = {
                name: document.getElementById('trackName').value || "",
                surveyor: document.getElementById('surveyorName').value || "",
                image: currentImageData,
                points: recordedPoints || [],
                dist: fixedDistance || 0
            };
            localStorage.setItem('pea_gps_draft', JSON.stringify(draft));
        }

        function checkForDraft() {
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÅ‡∏ó‡πá‡∏ö GPS
            var draft = localStorage.getItem('pea_gps_draft');
            if(draft) {
                var d = JSON.parse(draft);
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏Å‡πÑ‡∏ß‡πâ
                if((d.name && d.name !== "") || (d.points && d.points.length > 0)) {
                    document.getElementById('resumeAlert').style.display = 'block';
                    var ptCount = d.points ? d.points.length : 0;
                    var distVal = d.dist ? Math.round(d.dist) : 0;
                    var nameVal = d.name ? d.name : "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)";
                    document.getElementById('resumeInfo').innerText = `‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${nameVal} | ${ptCount} ‡∏´‡∏°‡∏∏‡∏î | ${distVal} ‡∏°.`;
                }
            } else {
                document.getElementById('resumeAlert').style.display = 'none';
            }
        }
        
        function pauseSurvey() {
            // ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ‡∏´‡∏¢‡∏∏‡∏î GPS ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÅ‡∏ï‡πà Draft ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà
            if(watchID) navigator.geolocation.clearWatch(watchID); watchID = null;
            alert("‚è∏ ‡∏û‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏î‡πâ\n‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏™‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°'");
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏•‡∏ö Draft)
            document.getElementById('btnStartGPS').style.display = 'block';
            document.getElementById('btnDropPin').style.display = 'none';
            document.getElementById('savePanel').style.display = 'none';
            document.getElementById('gpsBox').style.opacity = "0.6"; 
            document.getElementById('gpsStatusText').innerText = "‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏ß‡∏à' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î GPS";
            document.getElementById('displayAccuracy').innerText = "-";
            document.getElementById('displayDistFromLast').innerText = "0";
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('cameraInput').value = "";
            document.getElementById('imgStatus').style.display = 'none';
            document.getElementById('trackName').value = "";
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Draft ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
            checkForDraft();
        }

        function resumeSurvey() {
            var draft = JSON.parse(localStorage.getItem('pea_gps_draft'));
            if(!draft) return;

            // Restore Data
            document.getElementById('trackName').value = draft.name || "";
            document.getElementById('surveyorName').value = draft.surveyor || "";
            currentImageData = draft.image;
            recordedPoints = draft.points || [];
            fixedDistance = draft.dist || 0;

            // UI Restore
            if(currentImageData) {
                document.getElementById('previewImg').src = currentImageData;
                document.getElementById('previewImg').style.display = 'block';
                document.getElementById('imgStatus').style.display = 'none';
            }
            document.getElementById('resumeAlert').style.display = 'none';
            
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏∏‡∏î ‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î GPS ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if(recordedPoints.length > 0) {
                document.getElementById('gpsBox').style.opacity = "1";
                document.getElementById('gpsBox').style.pointerEvents = "auto";
                document.getElementById('displayPoints').innerText = recordedPoints.length;
                document.getElementById('displayDistance').innerText = fixedDistance.toFixed(0);
                
                document.getElementById('btnStartGPS').style.display = 'none';
                document.getElementById('btnDropPin').style.display = 'block';
                document.getElementById('savePanel').style.display = 'block';
                
                // Restart GPS
                startGPSWatcher();
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° GPS ‡∏Å‡πá‡πÅ‡∏Ñ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ
                alert("‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏ß‡∏à' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠");
            }
        }

        function clearDraft() {
            if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                localStorage.removeItem('pea_gps_draft');
                document.getElementById('resumeAlert').style.display = 'none';
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                document.getElementById('trackName').value = "";
                document.getElementById('surveyorName').value = "";
                document.getElementById('previewImg').style.display = 'none';
                currentImageData = null;
                recordedPoints = [];
            }
        }

        function resetSurvey(skipConfirm) {
            // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á)
            if(!skipConfirm && !confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ")) return;
            if(watchID) navigator.geolocation.clearWatch(watchID); watchID = null;
            
            // Clear draft on manual reset
            localStorage.removeItem('pea_gps_draft');

            document.getElementById('btnStartGPS').style.display = 'block';
            document.getElementById('btnDropPin').style.display = 'none';
            document.getElementById('savePanel').style.display = 'none';
            document.getElementById('gpsBox').style.opacity = "0.6"; 
            document.getElementById('gpsStatusText').innerText = "‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏ß‡∏à' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î GPS";
            document.getElementById('displayAccuracy').innerText = "-";
            document.getElementById('displayDistFromLast').innerText = "0";
            currentImageData = null;
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('cameraInput').value = "";
            document.getElementById('imgStatus').style.display = 'none';
            document.getElementById('trackName').value = "";
            
            checkForDraft();
        }

        function calcDist(lat1, lon1, lat2, lon2) {
            var R = 6371e3; var œÜ1 = lat1 * Math.PI/180; var œÜ2 = lat2 * Math.PI/180;
            var ŒîœÜ = (lat2-lat1) * Math.PI/180; var ŒîŒª = (lon2-lon1) * Math.PI/180;
            var a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
        }

        function saveTrack() {
            if(recordedPoints.length < 2) { alert("‚ö† ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏à‡∏∏‡∏î"); return; }
            var name = document.getElementById('trackName').value;
            var surveyor = document.getElementById('surveyorName').value;
            var now = new Date();
            var dateStr = now.toLocaleDateString('th-TH') + " " + now.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
            var safeDate = dateStr.replace(/[: \/]/g, '-');
            
            if(watchID) navigator.geolocation.clearWatch(watchID); watchID = null;

            var btn = document.getElementById('btnFinalSave');
            var originalText = btn.innerText;
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå (Drive)..."; btn.disabled = true;

            var kmlContent = genKML({name:name, surveyor:surveyor, dist:fixedDistance, points:recordedPoints});
            var tempId = Date.now();
            var newTrack = { 
                id: tempId, name: name, surveyor: surveyor, date: dateStr, 
                dist: fixedDistance, points: recordedPoints, uploaded: false, 
                image: currentImageData, drawStatus: 'pending', shared: false
            };
            var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
            savedTracks.push(newTrack);
            localStorage.setItem('pea_gps_tracks', JSON.stringify(savedTracks));

            fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ 
                    action: 'upload', 
                    folderName: name, 
                    filename: name + "_" + safeDate + ".kml", 
                    content: kmlContent, 
                    surveyor: surveyor, 
                    image: currentImageData
                })
            })
            .then(res => res.json()).then(data => {
                if(data.status === 'success') { 
                    var tracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
                    var target = tracks.find(t => t.id === tempId);
                    if(target) {
                        target.uploaded = true;
                        target.kmlUrl = data.kmlUrl;
                        target.imgUrl = data.imgUrl;
                        localStorage.setItem('pea_gps_tracks', JSON.stringify(tracks));
                    }
                }
            })
            .finally(() => {
                // ‡∏•‡∏ö Draft ‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                localStorage.removeItem('pea_gps_draft'); 
                
                btn.innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!";
                setTimeout(() => {
                    btn.innerText = originalText; btn.disabled = false;
                    // Reset UI ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                    document.getElementById('btnStartGPS').style.display = 'block';
                    document.getElementById('btnDropPin').style.display = 'none';
                    document.getElementById('savePanel').style.display = 'none';
                    document.getElementById('gpsBox').style.opacity = "0.6"; 
                    document.getElementById('gpsStatusText').innerText = "‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏ß‡∏à' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î GPS";
                    document.getElementById('displayAccuracy').innerText = "-";
                    document.getElementById('displayDistFromLast').innerText = "0";
                    currentImageData = null;
                    document.getElementById('previewImg').style.display = 'none';
                    document.getElementById('cameraInput').value = "";
                    document.getElementById('imgStatus').style.display = 'none';
                    document.getElementById('trackName').value = "";
                    
                    loadSavedTracks(); fetchSurveyors(); checkForDraft();
                }, 1500);
            });
        }

        function shareToTeam(id) {
            var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
            var track = savedTracks.find(t => t.id === id);
            if(!track) return;
            if(!track.uploaded || !track.kmlUrl) { alert("‚ö† ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"); return; }
            if(track.shared && !confirm("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏ã‡πâ‡∏≥?")) return;

            var btn = document.getElementById('shareBtn-' + id);
            if(btn) btn.innerText = "‚è≥...";

            fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ 
                    action: 'share_to_team', 
                    name: track.name,
                    surveyor: track.surveyor,
                    dist: track.dist,
                    kmlUrl: track.kmlUrl,
                    imgUrl: track.imgUrl,
                    status: track.drawStatus
                })
            })
            .then(res => res.json()).then(data => {
                if(data.status === 'success') {
                    track.shared = true;
                    localStorage.setItem('pea_gps_tracks', JSON.stringify(savedTracks));
                    loadSavedTracks();
                    alert("‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                }
            });
        }

        function applyFilters() {
            var svFilter = document.getElementById('filterSurveyor').value;
            var stFilter = document.getElementById('filterStatus').value;
            var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
            var filtered = savedTracks.filter(t => {
                var matchSv = (svFilter === 'all') || (t.surveyor === svFilter);
                var matchSt = (stFilter === 'all') || (t.drawStatus === stFilter);
                return matchSv && matchSt;
            });
            updateSummaryTable(filtered);
        }
        function updateFilterOptions(tracks) {
            var surveyors = [...new Set(tracks.map(t => t.surveyor))];
            var sel = document.getElementById('filterSurveyor');
            var currentVal = sel.value;
            sel.innerHTML = '<option value="all">‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            surveyors.forEach(s => { if(s) { var opt = document.createElement('option'); opt.value = s; opt.innerText = s; sel.appendChild(opt); } });
            sel.value = currentVal;
        }
        function toggleDrawStatus(id) {
            var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
            var track = savedTracks.find(t => t.id === id);
            if(track) {
                track.drawStatus = (track.drawStatus === 'done') ? 'pending' : 'done';
                localStorage.setItem('pea_gps_tracks', JSON.stringify(savedTracks));
                loadSavedTracks();
            }
        }
        function toggleSummaryTable() {
            var tbl = document.getElementById('personalWrapper');
            tbl.style.display = (tbl.style.display === 'none' || tbl.style.display === '') ? 'block' : 'none';
        }
        function updateSummaryTable(tracks) {
            var tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = "";
            document.getElementById('personalWrapper').style.display = 'block';
            tracks.forEach((t, index) => {
                var statusText = (t.drawStatus === 'done') ? '<span style="color:green">‚úî ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>' : '<span style="color:red">‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</span>';
                var imgTag = t.image ? `<img src="${t.image}" class="table-thumb" onclick="showImage(${t.id})">` : "-";
                var row = `<tr><td>${index + 1}</td><td>${imgTag}</td><td>${t.name}</td><td>${t.surveyor||'-'}</td><td>${t.dist.toFixed(0)}</td><td>${statusText}</td></tr>`;
                tbody.innerHTML += row;
            });
        }
        
        // --- Fullscreen Toggle Logic (Corrected) ---
        function toggleFullscreen(containerId) {
            var elem = document.getElementById(containerId);
            if (elem.classList.contains('fullscreen-overlay')) {
                elem.classList.remove('fullscreen-overlay');
                document.body.classList.remove('noscroll');
                elem.querySelector('.close-fs-btn').style.display = 'none';
                elem.querySelector('.fullscreen-btn').style.display = 'inline-block';
            } else {
                elem.classList.add('fullscreen-overlay');
                document.body.classList.add('noscroll');
                elem.querySelector('.close-fs-btn').style.display = 'block';
                elem.querySelector('.fullscreen-btn').style.display = 'none';
            }
        }

        // --- Public Data (Locked) ---
        function initViewTeamData() {
            if(isTeamDataUnlocked) {
                fetchPublicData();
            } else {
                currentPassAction = 'view_team';
                document.getElementById('passwordPromptText').innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°";
                document.getElementById('adminPassword').value = "";
                document.getElementById('passwordModal').style.display = "flex";
                document.getElementById('adminPassword').focus();
            }
        }
        
        function fetchPublicData() {
            var btn = document.querySelector("button[onclick='initViewTeamData()']");
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..."; btn.disabled = true;
            fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ action: 'get_public_data' }) })
            .then(res => res.json()).then(resp => {
                globalPublicData = resp.data || [];
                updatePublicFilters();
                applyPublicFilters();
                document.getElementById('publicWrapper').style.display = 'block';
                btn.innerText = "üåê ‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á (‡∏ó‡∏µ‡∏°)"; btn.disabled = false;
            });
        }
        function updatePublicFilters() {
            var surveyors = [...new Set(globalPublicData.map(t => t.surveyor))];
            var sel = document.getElementById('publicFilterSurveyor');
            sel.innerHTML = '<option value="all">‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            surveyors.forEach(s => { if(s) { var opt = document.createElement('option'); opt.value = s; opt.innerText = s; sel.appendChild(opt); } });
        }
        function applyPublicFilters() {
            var svFilter = document.getElementById('publicFilterSurveyor').value;
            var stFilter = document.getElementById('publicFilterStatus').value;
            var filtered = globalPublicData.filter(t => {
                var matchSv = (svFilter === 'all') || (t.surveyor === svFilter);
                var matchSt = (stFilter === 'all') || (t.status === stFilter);
                return matchSv && matchSt;
            });
            renderPublicTable(filtered);
        }
        
        function togglePublicStatus(kmlUrl, currentStatus, btn) {
            var newStatus = (currentStatus === 'done') ? 'pending' : 'done';
            btn.innerText = "‚è≥...";
            fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'update_status', kmlUrl: kmlUrl, newStatus: newStatus })
            }).then(res => res.json()).then(data => {
                if(data.status === 'success') {
                    var target = globalPublicData.find(t => t.kml === kmlUrl);
                    if(target) target.status = newStatus;
                    applyPublicFilters();
                }
            });
        }

        function renderPublicTable(data) {
            var tbody = document.getElementById('publicTableBody');
            tbody.innerHTML = "";
            if(data.length > 0) {
                for(var i=data.length-1; i>=0; i--) {
                    var item = data[i];
                    var imgTag = item.img ? `<a href="${item.img}" target="_blank">üì∑</a>` : "-";
                    var isDone = (item.status === 'done');
                    var statusLabel = isDone ? "‚úî ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô";
                    var statusClass = isDone ? "status-done" : "status-pending";
                    var statusBtn = `<button class="status-btn ${statusClass}" onclick="togglePublicStatus('${item.kml}', '${item.status}', this)">${statusLabel}</button>`;

                    var row = `<tr>
                        <td>${data.length - i}</td>
                        <td>${item.date}</td>
                        <td style="text-align:center;">${imgTag}</td>
                        <td>${item.name}</td>
                        <td>${item.surveyor}</td>
                        <td>${item.dist}</td>
                        <td>${statusBtn}</td>
                        <td><a href="${item.kml}" target="_blank">‚¨á KML</a></td>
                    </tr>`;
                    tbody.innerHTML += row;
                }
            } else { tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>"; }
        }

        // --- Load & Utils ---
        function loadSavedTracks() {
            var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
            var container = document.getElementById('savedRoutesList');
            var listContainer = document.getElementById('savedListContainer');
            container.innerHTML = "";
            if (savedTracks.length === 0) { listContainer.style.display = "none"; document.getElementById('personalWrapper').style.display = 'none'; return; }
            listContainer.style.display = "block";
            updateFilterOptions(savedTracks);
            for (var i = savedTracks.length - 1; i >= 0; i--) {
                var t = savedTracks[i];
                var uploadStatus = t.uploaded ? '<span style="color:#2e7d32;">‚úî Drive</span>' : '<span style="color:#f57f17;">‚ö† Local</span>';
                var number = (savedTracks.length - i);
                var photoBtn = t.image ? `<button onclick="showImage(${t.id})" style="background-color:#607d8b;">üì∑ ‡∏£‡∏π‡∏õ</button>` : '';
                var isDone = (t.drawStatus === 'done');
                var statusClass = isDone ? "status-done" : "status-pending";
                var statusBtn = `<button class="status-btn ${statusClass}" onclick="toggleDrawStatus(${t.id})">${isDone ? "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡∏±‡∏á"}</button>`;
                var shareColor = t.shared ? "#4caf50" : "#1565c0";
                var shareBtn = t.uploaded ? `<button id="shareBtn-${t.id}" onclick="shareToTeam(${t.id})" style="background-color:${shareColor}; margin-top:5px;">${t.shared ? "‚úî ‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß" : "‚òÅ ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á"}</button>` : '';

                var html = `
                <div class="history-item">
                    <div class="upload-status" style="display:block;">${uploadStatus}</div>
                    <div>
                        <div class="history-info">${number}. ${t.name} ${statusBtn}</div>
                        <div class="history-meta" style="margin-top:5px;">${t.dist.toFixed(0)} ‡∏°. | ${t.date}</div>
                    </div>
                    <div class="history-actions" style="margin-top:10px; flex-wrap:wrap;">
                        ${photoBtn}
                        <button onclick="exportSingleTrack(${t.id})" style="background-color:#ff9800;">‚¨á KML</button>
                        <button onclick="initDelete('single', ${t.id})" style="background-color:#d32f2f;">üóë ‡∏•‡∏ö</button>
                    </div>
                    ${shareBtn}
                </div>`;
                container.innerHTML += html;
            }
            applyFilters();
        }
        function handleImageSelect(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = document.getElementById('previewImg'); img.src = e.target.result; img.style.display = 'block';
                    document.getElementById('imgStatus').style.display = 'none'; 
                    compressImage(e.target.result, 800, 0.7, function(compressedData) { currentImageData = compressedData; saveToDraft(); });
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        function compressImage(base64Str, maxWidth, quality, callback) {
            var img = new Image(); img.src = base64Str;
            img.onload = function () {
                var canvas = document.createElement('canvas');
                var width = img.width; var height = img.height;
                if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                canvas.width = width; canvas.height = height;
                var ctx = canvas.getContext("2d"); ctx.drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL("image/jpeg", quality));
            }
        }
        function showImage(id) {
            var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
            var track = savedTracks.find(t => t.id === id);
            if(track && track.image) { document.getElementById('fullImage').src = track.image; document.getElementById('imageModal').style.display = 'flex'; }
        }
        function closeImageModal() { document.getElementById('imageModal').style.display = 'none'; }
        function fetchSurveyors() {
            fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ action: 'get_surveyors' }) })
            .then(res => res.json()).then(data => {
                var list = document.getElementById('surveyorList'); list.innerHTML = "";
                data.names.forEach(name => { var opt = document.createElement('option'); opt.value = name; list.appendChild(opt); });
            });
        }
        function genKML(track) {
            var desc = `Surveyor: ${track.surveyor || '-'}\nDistance: ${track.dist.toFixed(0)} m`;
            var k = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>${track.name}</name><description>${desc}</description><Style id="lineStyle"><LineStyle><color>ff0000ff</color><width>4</width></LineStyle></Style><Style id="pinStyle"><IconStyle><scale>1.1</scale><Icon><href>http://maps.google.com/mapfiles/kml/pushpin/red-pushpin.png</href></Icon></IconStyle></Style><Placemark><name>Path</name><styleUrl>#lineStyle</styleUrl><LineString><tessellate>1</tessellate><coordinates>`;
            for (var i = 0; i < track.points.length; i++) { k += track.points[i][0] + "," + track.points[i][1] + ",0 "; }
            k += `</coordinates></LineString></Placemark><Folder><name>Points</name>`;
            for (var j = 0; j < track.points.length; j++) { k += `<Placemark><name>P${j+1}</name><styleUrl>#pinStyle</styleUrl><Point><coordinates>${track.points[j][0]},${track.points[j][1]},0</coordinates></Point></Placemark>`; }
            k += `</Folder></Document></kml>`;
            return k;
        }
        function exportSingleTrack(id) {
            var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
            var track = savedTracks.find(t => t.id === id); if (!track) return;
            var kmlContent = genKML(track);
            var blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a'); link.href = url; link.download = track.name + ".kml";
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        
        // --- Password Logic (Shared) ---
        function initDelete(mode, id) { 
            currentPassAction = 'delete';
            deleteMode = mode; 
            deleteTargetId = id; 
            document.getElementById('passwordPromptText').innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            document.getElementById('adminPassword').value = ""; 
            document.getElementById('passwordModal').style.display = "flex"; 
            document.getElementById('adminPassword').focus(); 
        }
        function closeModal() { document.getElementById('passwordModal').style.display = "none"; }
        document.getElementById('btnConfirmPassword').onclick = function() {
            var pass = document.getElementById('adminPassword').value; var btn = document.getElementById('btnConfirmPassword'); if(!pass) return;
            btn.innerText = "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö..."; btn.disabled = true;
            fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'check_pass', password: pass }) })
            .then(res => res.json()).then(data => { 
                if(data.valid) { 
                    closeModal();
                    if(currentPassAction === 'delete') performDelete();
                    else if(currentPassAction === 'view_team') { isTeamDataUnlocked = true; fetchPublicData(); }
                } else alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î"); 
            })
            .finally(() => { btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"; btn.disabled = false; });
        };
        function performDelete() {
            if (deleteMode === 'all') localStorage.removeItem('pea_gps_tracks');
            else { var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]"); savedTracks = savedTracks.filter(t => t.id !== deleteTargetId); localStorage.setItem('pea_gps_tracks', JSON.stringify(savedTracks)); }
            loadSavedTracks();
        }
        
        // Init Check
        window.onload = function() { loadSavedTracks(); fetchSurveyors(); checkForDraft(); };
    </script>
</body>
</html>